<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../behaviors/youtube-api-behavior.html">
<link rel="import" href="../behaviors/youtube-searchlist-behavior.html">
<link rel="import" href="../behaviors/utility-functions-behavior.html">
<link rel="import" href="../fic-list-item/fic-list-item.html">

<dom-module id="fic-channel-videos">
  <template>
    <style>
      :host {
        display: block;
      }

      fic-list-item {
        margin: 16px 0;
      }

      fic-list-item:first-child {
        margin-top: 0;
      }

      fic-list-item:last-child {
        margin-bottom: 0;
      }

      :host::shadow #grid {
        margin-left: 14px;
        margin-right: 14px;
      }

      :host::shadow #grid .scrollable-inner {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        margin-left: auto;
        margin-right: auto;
      }

      @media (max-width: 920px) {
        :host::shadow #grid .scrollable-inner {
          max-width: 580px;
        }
      }

      @media (max-width: 630px) {
        :host::shadow #grid .scrollable-inner {
          max-width: 290px;
        }
      }

      :host::shadow #grid fic-list-item {
        width: 290px;
        overflow: hidden;
        margin: 16px 0;
      }

      :host::shadow #grid fic-list-item .details {
        max-width: 100px;
      }

      @media (min-width: 601px) and (max-width: 768px) {
        :host::shadow #list fic-list-item .container {
          @apply(--layout-vertical);
          @apply(--layout-center);
        }
        :host::shadow #list fic-list-item h3 {
          text-align: center;
        }
      }

      @media (min-width: 601px) {
        :host #list {
          overflow-y: auto;
          overflow-x: hidden;
          max-height: 480px;
        }
      }

      paper-dialog {
        @apply(--layout-vertical);
        height: 531px;
        width: 560px;
      }

      paper-dialog paper-material {
        margin-top: 14px;
      }

      paper-dialog .description {
        overflow-y: auto;
      }

      paper-dialog .dialogicons {
        @apply(--layout-self-end);
        margin-top: 15px;
      }

      paper-dialog .dialogicons .close {
        cursor: pointer;
      }

      paper-dialog .title {
        @apply(--fic-channel-videos-title);
      }

      :host::shadow #videodialog paper-material {
        @apply(--shadow-none);
      }

      .more paper-button {
        @apply(--more-button);
      }
    </style>
    <paper-dialog entry-animation="scale-up-animation" exit-animation="fade-out-animation" id="videodialog" modal="true">
      <div class="dialogicons">
        <iron-icon icon="fic-icons:cross" class="close" on-click="_dialogClose"></iron-icon>
      </div>
      <paper-material flex>
        <google-youtube id="video" video-id="{{dialogData.videoId}}" fluid elevation="0"></google-youtube>
      </paper-material>
      <div class="title layout horizontal">
        <div class="text flex">{{dialogData.title}}</div>
        <div class="icons layout horizontal center">
          <iron-icon id="viewsicon" icon="fic-icons:view"></iron-icon>
          <paper-tooltip for="viewsicon">{{dialogData.views}}</paper-tooltip>
          <iron-icon id="publishedicon" icon="fic-icons:clock"></iron-icon>
          <paper-tooltip for="publishedicon">{{dialogData.published}}</paper-tooltip>
        </div>
      </div>
      <div class="description">{{dialogData.description}}</div>
    </paper-dialog>
    <div id="{{displayLayout}}" class="scrollable">
      <div class="scrollable-inner">
        <template is="dom-repeat" items="{{videos}}">
          <fic-list-item api="{{api}}" conf="{{conf}}" video-id="{{item.id.videoId}}" dialog-data="{{dialogData}}"></fic-list-item>
        </template>
      </div>
    </div>
    <div class="more layout vertical center">
      <paper-button raised on-click="_nextPage">Carregar Mais VÃ­deos...</paper-button>
    </div>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'fic-channel-videos',
        properties: {
          channelId: String,
          query: {
            type: String,
            observer: '_fetchChannel'
          },
          poolSize: {
            type: Number,
            value: 4
          },
          order: {
            type: String,
            value: 'viewCount'
          },
          shuffle: {
            type: Boolean,
            value: false
          },
          videos: Array,
          dialogData: {
            type: Object,
            value: function() {
              return {
                videoId: null,
                title: null,
                description: null,
                published: null,
                views: null
              };
            },
            observer: '_dialogUpdated'
          },
          displayLayout: {
            type: String,
            value: 'list'
          },
          nextPage: Object
        },
        behaviors: [
          FicBehaviors.UtilityFunctionsBehavior,
          FicBehaviors.YoutubeApiBehavior,
          Polymer.NeonAnimationRunnerBehavior
        ],
        listeners: {
          'readyApi': '_fetchChannel',
          'receivedChannel': '_fetchVideos',
          'receivedNewPage': '_addNewVideos',
          'receivedVideos': '_scroll'
        },
        _fetchChannel: function() {
          if (!this.api) {
            return;
          }
          console.log('fic-channel-videos API Ready');
          if (this.channelId) {
            // If channelId comes from element property
            this.fire('receivedChannel', this.channelId);
            return;
          }

          // Fetch first channel for the available conf
          var req = this.api.channels.list({
            forUsername: this.conf.channel,
            part: 'id',
            key: this.conf.apiKey,
            maxResults: 1
          });

          // Execute
          var t = this;
          req.execute(function(res) {
            t.fire('receivedChannel', res.items[0].id);
          });
        },
        _fetchVideos: function(event) {
          var params = {
            key: this.conf.apiKey,
            part: 'id',
            channelId: event.detail,
            maxResults: this.poolSize,
            type: 'video',
            order: this.order
          };

          // Search
          if (this.query) {
            params.q = this.query;
          }

          var req = this.api.search.list(params);

          var t = this;
          req.execute(function(res) {
            if (res.nextPageToken) {
              params.pageToken = res.nextPageToken;
              t.nextPage = params;
            }
            t.fire('receivedVideos', res.items);
            t.videos = res.items;
          });
        },
        _dialogUpdated: function() {
          if (this.dialogData.videoId) {
            this.$.videodialog.open();
            this.$$('#video').play();
          }
        },
        _dialogClose: function() {
          this.$$('#video').pause();
          this.$.videodialog.close();
        },
        _nextPage: function() {
          if (!this.nextPage) {
            console.log('no more pages');
            return;
          }

          var req = this.api.search.list(this.nextPage);

          var t = this;
          req.execute(function(res) {
            if (res.nextPageToken) {
              console.log('storing page token', res.nextPageToken);
              t.nextPage.pageToken = res.nextPageToken;
            } else {
              console.log('no more pages, nulling nextPage');
              t.nextPage = null;
            }
            t.fire('receivedNewPage', res.items);
          });
        },
        _addNewVideos: function(event) {
          var t = this;
          event.detail.forEach(function(item) {
            t.push('videos', item);
            t.fire('receivedVideos', t.videos);
          });
        },
        _scroll: function() {
          var t = this;
          setTimeout(function() {
            t.$$('.scrollable').scrollTop = t.$$('.scrollable').scrollHeight;
          }, 300);
        }
      });
    })();
  </script>
</dom-module>

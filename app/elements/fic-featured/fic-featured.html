<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../behaviors/youtube-api-behavior.html">
<link rel="import" href="../behaviors/utility-functions-behavior.html">

<dom-module id="fic-featured">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <google-youtube video-id="{{videoId}}"></google-youtube>
    <paper-material>{{videoDescription}}</paper-material>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'fic-featured',
        properties: {
          channelId: String,
          poolSize: {
            type: Number,
            value: 10
          },
          topicId: String,
          videoCategoryId: Number,
          order: {
            type: String,
            value: 'viewCount'
          },
          videoId: {
            type: String,
            value: ''
          },
          videoDescription: String
        },
        behaviors: [
          FicBehaviors.UtilityFunctionsBehavior,
          FicBehaviors.YoutubeApiBehavior
        ],
        listeners: {
          'readyApi': '_fetchChannel',
          'receivedChannel': '_searchVideo',
          'receivedVideo': '_fetchVideoDetails'
        },
        _fetchChannel: function() {
          if (this.channelId) {
            // If channelId comes from element property
            this.fire('receivedChannel', this.channelId);
            return;
          }

          console.log('fic-featured API Ready');

          // Fetch first channel for the available conf
          var req = this.api.channels.list({
            forUsername: this.conf.channel,
            part: 'invideoPromotion',
            key: this.conf.apiKey,
            maxResults: 1
          });

          // Execute
          var t = this;
          req.execute(function(res) {
            t.fire('receivedChannel', res.items[0].id);
          });
        },
        _searchVideo: function(event) {
          if (this.videoId) {
            // If videoId comes from element property
            this.fire('receivedVideo', {
              id: this.videoId
            });
            return;
          }

          var chId = event.detail;

          // Build params from element properties
          var t = this;
          var params = Object.keys(this.properties);
          params = params.reduce(function(prev, cur) {
            if (t[cur]) {
              prev[cur] = t[cur];
            }
            return prev;
          }, {});

          // Add needed parameters
          params.part = 'snippet';
          params.channelId = chId;
          params.key = this.conf.apiKey;
          params.maxResults = this.poolSize;

          // Execute
          var req = this.api.search.list(params);
          req.execute(function(res) {
            // Shuffle pool list and use the first one
            res = t.shuffle(res.items)[0];

            t.videoId = res.id;
            t.fire('receivedVideo', res);
          });
        },
        _fetchVideoDetails: function(event) {
          if (this.videoDescription) {
            // If videoDescription comes from element property
            this.fire('receivedVideoDetails', {
              videoDescription: this.videoId
            });
            return;
          }

          // Build params
          var params = {
            part: 'snippet',
            id: event.detail.id.videoId,
            key: this.conf.apiKey,
            maxResults: 1
          };

          // Execute
          var req = this.api.videos.list(params);
          var t = this;
          req.execute(function(res) {
            res = res.items[0];
            t.videoDescription = res.snippet.description;
            t.fire('receivedVideoDetails', res);
          });
        }
      });
    })();
  </script>
</dom-module>
